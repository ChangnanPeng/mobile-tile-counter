<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <!-- 防止移动端双击缩放 -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>九宫格计数器</title>
  <meta name="description" content="下半屏九宫格按钮（1-9），点击对应数字计数并在上半屏显示的轻量移动网页小程序示例。" />
  <link rel="icon" href="assets/icon.png" />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0f62fe" />
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: #f9fafb;
      color: #111827;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }
    .app { flex: 1; display: flex; flex-direction: column; }
    .display { flex: 1; padding: 1rem; overflow-y: auto; }
    .title { font-size: 1.3rem; font-weight: bold; margin-bottom: .5rem; }
    .summary { font-size: 1.1rem; margin-bottom: .5rem; }
    .counts .row { display: flex; align-items: center; margin-bottom: .4rem; }
    .counts .row span { width: 1.5rem; font-weight: bold; }
    .box { width: 18px; height: 18px; margin: 2px; border: 1px solid #374151; display: inline-block; border-radius: 3px; }
    .green { background: #4caf50; }
    .gray { background: #d1d5db; }
    .grid-wrap { background: #fff; border-top: 1px solid #e5e7eb; padding: .5rem; }
    .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: .5rem; }
    .grid-btn {
      aspect-ratio: 1;
      font-size: 1.4rem;
      font-weight: 600;
      border-radius: 12px;
      border: 1px solid #d1d5db;
      background: #f3f4f6;
      transition: background .2s;
      touch-action: manipulation;
    }
    .grid-btn:active { background: #dbeafe; }
    .bar {
      position: fixed;
      bottom: -3rem;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.85);
      color: #fff;
      padding: .6rem 1rem;
      border-radius: 12px;
      font-size: .9rem;
      transition: bottom .3s;
      z-index: 1000;
    }
    .bar.show { bottom: 1.2rem; }
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; }

    /* 能力覆盖层样式 */
    #abilityOverlay {
      display:none;
      position:fixed;
      top:0; left:0; right:0; bottom:0;
      background:#fff;
      color:#111827;
      padding:1rem;
      font-size:1rem;
      line-height:1.5;
      overflow-y:auto;
      z-index:2000;
    }
    #abilityOverlay pre { white-space: pre-wrap; }
  </style>
</head>
<body>
  <main class="app" id="app">
    <section class="display" id="display">
      <div class="title" id="title">九宫格计数器（剩余 45/45）</div>
      <div class="summary" id="summary">当前计数</div>
      <div class="counts" id="countList" aria-hidden="false"></div>

      <!-- 工具按钮区域 -->
      <div style="margin-top:.8rem; display:flex; gap:.5rem;">
        <button id="exportBtn" style="border:none; padding:.45rem .65rem; border-radius:10px; background:#111827;color:white;">导出</button>
        <button id="resetBtn" style="border:1px solid #e5e7eb; padding:.45rem .65rem; border-radius:10px; background:white;">重置</button>
        <button id="abilityBtn" style="border:1px solid #0f62fe; padding:.45rem .65rem; border-radius:10px; background:#0f62fe;color:white;">能力</button>
      </div>
    </section>

    <section class="grid-wrap" aria-hidden="false">
      <div class="grid" role="application" aria-label="九宫格按键区域，数字 1 到 9">
        <button class="grid-btn" data-num="1">1</button>
        <button class="grid-btn" data-num="2">2</button>
        <button class="grid-btn" data-num="3">3</button>
        <button class="grid-btn" data-num="4">4</button>
        <button class="grid-btn" data-num="5">5</button>
        <button class="grid-btn" data-num="6">6</button>
        <button class="grid-btn" data-num="7">7</button>
        <button class="grid-btn" data-num="8">8</button>
        <button class="grid-btn" data-num="9">9</button>
      </div>
    </section>

    <div id="ariaLive" class="sr-only" aria-live="polite"></div>
    <div id="hintBar" class="bar" role="status" aria-hidden="true"></div>

    <!-- 能力覆盖层 -->
    <div id="abilityOverlay">
<pre>
1 古代巨龙 
掷骰：所有其他的玩家根据掷骰结果失去相当数量的生命。召唤巨龙失败则你失去相当数量的生命。
2 黑暗幽灵
所有其他玩家失去1点生命。你获得1点生命（最多6点生命）。
3 甜蜜的梦
掷骰：根据掷骰结果，你获得相当数量的生命（最多6点生命）。
4 猫头鹰
你可以查看一个秘密咒语石，并放到你的面前。如果这一轮你存活，每个可以让你额外多得1分。
5 闪电暴风雨
你左手和右手边的玩家各失去1点生命。
6 暴风雪
你左手边的玩家失去1点生命。
7 火球
你右手边的玩家失去1点生命。
8 魔法药水
你获得1点生命（最多6点生命）。
9 力量药水
你把成功使用的力量药水放到你的面前。每2个力量药水可以让你在使其他玩家失去生命时，失去生命的点数+1。
（点击屏幕任意位置关闭此页面）
</pre>
    </div>
  </main>

  <script>
    // 阻止快速双击缩放
    let lastTouchTime = 0;
    document.addEventListener('touchstart', function(event) {
      const now = new Date().getTime();
      if (now - lastTouchTime <= 300) { event.preventDefault(); }
      lastTouchTime = now;
    }, { passive: false });

    // 初始化状态
    let state = JSON.parse(localStorage.getItem("counterState") || "{}");
    for (let i = 1; i <= 9; i++) if (state[i] === undefined) state[i] = 0;

    const countList = document.getElementById("countList");
    const summary = document.getElementById("summary");
    const title = document.getElementById("title");
    const ariaLive = document.getElementById("ariaLive");
    const totalGreenBoxes = 1+2+3+4+5+6+7+8+9; // 45

    function renderCounts() {
      countList.innerHTML = "";
      let hasAny = false;
      let remaining = 0;

      for (let i = 1; i <= 9; i++) {
        const row = document.createElement("div");
        row.className = "row";
        row.setAttribute("data-num", i);

        const label = document.createElement("span");
        label.textContent = i;
        row.appendChild(label);

        for (let j = 0; j < i; j++) {
          const box = document.createElement("div");
          if (j < i - state[i]) {
            box.className = "box green";
            remaining++;
          } else {
            box.className = "box gray";
          }
          row.appendChild(box);
        }

        countList.appendChild(row);
        if (state[i] > 0) hasAny = true;
      }

      title.textContent = `九宫格计数器（剩余 ${remaining}/${totalGreenBoxes}）`;
      summary.textContent = hasAny ? "当前状态：" : "当前计数为空";
    }

    // 数字按钮点击
    document.querySelectorAll(".grid-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const num = parseInt(btn.dataset.num);
        if (state[num] < num) {
          state[num]++;
          localStorage.setItem("counterState", JSON.stringify(state));
          renderCounts();
          ariaLive.textContent = `数字 ${num} 变灰 ${state[num]} 个方框`;
        }
      });
    });

    // 重置按钮
    document.getElementById("resetBtn").addEventListener("click", () => {
      for (let i = 1; i <= 9; i++) state[i] = 0;
      localStorage.setItem("counterState", JSON.stringify(state));
      renderCounts();
    });

    // 导出按钮
    document.getElementById("exportBtn").addEventListener("click", () => {
      const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "state.json";
      a.click();
      URL.revokeObjectURL(url);
    });

    // 能力按钮
    const abilityBtn = document.getElementById("abilityBtn");
    const abilityOverlay = document.getElementById("abilityOverlay");
    abilityBtn.addEventListener("click", () => { abilityOverlay.style.display = "block"; });
    abilityOverlay.addEventListener("click", () => { abilityOverlay.style.display = "none"; });

    renderCounts();

    // 注册 Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(reg => {
            console.log('Service Worker 注册成功:', reg.scope);
            reg.onupdatefound = () => {
              const newWorker = reg.installing;
              newWorker.onstatechange = () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  showUpdateBar();
                }
              };
            };
          })
          .catch(err => console.error('Service Worker 注册失败:', err));
      });
      navigator.serviceWorker.addEventListener('controllerchange', () => window.location.reload());
    }

    function showUpdateBar() {
      const bar = document.getElementById('hintBar');
      bar.textContent = '发现新版本，点击刷新';
      bar.setAttribute('aria-hidden', 'false');
      bar.classList.add('show');
      bar.style.cursor = 'pointer';
      bar.addEventListener('click', () => {
        if (navigator.serviceWorker.waiting) {
          navigator.serviceWorker.waiting.postMessage({ action: 'skipWaiting' });
        }
      });
    }
  </script>
</body>
</html>
